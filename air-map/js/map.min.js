!function(){function o(o,e){var r=o[0].PublishTime;for(var t in o){o[t].PublishTime>=r&&($(".updateAt").text("更新時間："+o[t].PublishTime+"（每小時更新）"),r=o[t].PublishTime);var a,c=n(o[t]["PM2.5"]);a="yellow"==c.color?u:"brown"==c.color?p:L.AwesomeMarkers.icon({prefix:"fa",icon:"map-marker",markerColor:c.color});var s=i(o[t].SiteName,e),l=L.marker([s.TWD97Lat,s.TWD97Lon],{icon:a,opacity:.9}).addTo(d);l.bindPopup("<strong>測站名稱："+o[t].SiteName+'</strong><br/><span class="'+c.color+'">PM2.5 空污指標：'+c.disc+"</span><br/>PM2.5："+o[t]["PM2.5"]+"（μg/m3）<br/>PM10："+o[t].PM10+"（μg/m3）<br/>PSI："+o[t].PSI+"<br/>測站類型："+s.SiteType+"<br/>地址："+s.SiteAddress)}d3Initialize(d,e)}function i(o,i){for(var n in i)if(i[n].SiteName==o)return i[n]}function n(o){return 12>=o?{disc:"空氣品質良好",color:"green"}:35>=o?{disc:"空氣品質普通",color:"yellow"}:55>=o?{disc:"對敏感性族群不健康",color:"orange"}:150>=o?{disc:"空氣品質不良",color:"red"}:250>=o?{disc:"空氣品質非常不良",color:"purple"}:{disc:"空氣品質屬有害",color:"brown"}}function e(){d=new L.Map("map"),url="http://openmapsurfer.uni-hd.de/tiles/roadsg/x={x}&y={y}&z={z}",attrib='Imagery from <a href="http://giscience.uni-hd.de/">GIScience Research Group @ University of Heidelberg</a> &mdash; Map data &copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>';var o=new L.TileLayer(url,{minZoom:1,maxZoom:16,attribution:attrib});d.setView(new L.LatLng(24,121),7),o.addTo(d),l.addTo(d),m.addTo(d)}function r(){return navigator.geolocation?navigator.geolocation.getCurrentPosition(t):void 0}function t(o){d.setView(new L.LatLng(o.coords.latitude,o.coords.longitude),10)}function a(){d.setView(new L.LatLng(24,121),7)}function c(){s?$(".main-info").hide():$(".main-info").show(),s=!s}d3Initialize=require("./index");var d,s,l=L.control();window.getLocation=r,window.resetView=a,window.toogleInfo=c;var u=L.icon({iconUrl:"./images/yellow.png",iconSize:[35,45],iconAnchor:[17,42],popupAnchor:[0,-35]}),p=L.icon({iconUrl:"./images/brown.png",iconSize:[35,45],iconAnchor:[17,42],popupAnchor:[0,-35]});$(document).ready(function(){e(),d3.csv("./data/site.csv",function(i){var n=new Firebase("https://realtaiwanstat2.firebaseio.com");n.child("air").limitToLast(1).on("child_added",function(n){var e=n.val(),r=JSON.parse(e);o(r,i)})})}),l.onAdd=function(o){return this._div=L.DomUtil.create("div","info"),this._div.innerHTML='<h4 class="">格狀區塊：表示該區域內最近的測站</h4>',this._div};var m=L.control({position:"bottomright"});m.onAdd=function(o){for(var i=L.DomUtil.create("div","info legend"),n=["#5F2828","#E062C8","#F52305","#F7931C","yellow","#7FB73A"],e=["有害","非常不良","不良","接近不良","普通","良好"],r=0;r<e.length;r++)i.innerHTML+='<i style="background:'+n[r]+'"></i>'+e[r]+"<br/>";return i}}();