function bar(t,e){function r(t){function e(){d3.select(this).classed("mouse",!1),d3.selectAll("."+r).classed("mouse",!1)}d3.select(this).classed("mouse",!0).on("mouseleave",e);var r=t.key;d3.selectAll("."+r).classed("mouse",!0)}function n(t){return e[t]/1e5}for(var a=d3.nest().key(function(t){return t.案類}).key(function(t){return t.發生地點.substring(0,3)}).rollup(function(t){return t.length}).entries(t),s=getform(),l=a[s].values,u=0;u<l.length;u++)l[u].values=Math.round(l[u].values/n(l[u].key)*100)/100;for(var o=[],u=0;u<l.length;u++)o.push(l[u].values);var i=d3.max(o),c=d3.scale.linear().domain([0,i]).range([0,width-110]),d=d3.scale.linear().domain([0,21]).range([0,height]),f=d3.select("#bar");f.attr("width",width).attr("height",600).attr("viewBox","0 0 "+width+" 600");var v=f.append("g"),h=v.selectAll("rect").data(l),p=v.selectAll("text").data(l);h.enter().append("rect"),p.enter().append("text"),h.attr("class",function(t){return t.key}).sort(function(t,e){return e.values-t.values}).attr("x",110).attr("y",function(t,e){return d(e)}).attr("width",function(t){return c(t.values)}).attr("height",20).attr("fill",function(t){var e=.9-t.values/i*.6;return d3.hsl(gener_color,e,e)}).on("mouseover",r),d3.select("#map").select("g").selectAll("rect").sort(function(t,e){return e.values-t.values}).transition(),p.attr("class","labels").sort(function(t,e){return e.values-t.values}).attr("x",0).attr("y",function(t,e){return d(e)+14}).text(function(t){return""==t.key?"不詳 "+t.values:t.key+" "+t.values})}function change(){function t(t){function e(){d3.select(this).classed("mouse",!1),d3.selectAll("."+r).classed("mouse",!1)}d3.select(this).classed("mouse",!0).on("mouseleave",e);var r=t.key;d3.selectAll("."+r).classed("mouse",!0)}function e(t){return pop[t]/1e5}for(var r=d3.nest().key(function(t){return t.案類}).key(function(t){return t.發生地點.substring(0,3)}).rollup(function(t){return t.length}).entries(data),n=getform(),a=r[n].values,s=0;s<a.length;s++)a[s].values=Math.round(a[s].values/e(a[s].key)*100)/100;for(var l=[],s=0;s<a.length;s++)l.push(a[s].values);var u=d3.max(l),o=d3.scale.linear().domain([0,u]).range([0,width-110]),i=d3.scale.linear().domain([0,21]).range([0,height]),c=d3.select("#bar").select("g").selectAll("rect").data(a,function(t){return t.key}),d=d3.select("#bar").select("g").selectAll("text").data(a),f=d3.select("#map").select("g").selectAll("path");c.exit().remove(),d.exit().remove(),c.enter().append("rect").on("mouseover",t),d.enter().append("text"),c.sort(function(t,e){return e.values-t.values}).attr("fill","#fff").attr("width",0).transition().duration(750).attr("class",function(t){return t.key}).attr("x",110).attr("y",function(t,e){return i(e)}).attr("width",function(t){return o(t.values)}).attr("height",20).attr("fill",function(t){var e=.9-t.values/u*.6;return d3.hsl(gener_color,e,e)}),d.sort(function(t,e){return e.values-t.values}).transition().duration(750).attr("class","labels").attr("x",0).attr("y",function(t,e){return i(e)+14}).text(function(t){return t.key+" "+t.values}),f.transition().duration(750).attr("fill",function(t,e){for(var r=t.properties.C_Name,n=-100,s=0;s<a.length;s++)if(a[s].key==r){n=a[s].values;break}var l=.9-n/u*.6;return d3.hsl(gener_color,l,l)})}function ccrim(t){function e(t){return pop[t]/1e5}$("#City").attr("disabled",!0);var r=t.properties.C_Name;d3.select("form").select("text").attr("x",0).attr("y",0).text(r),$("select").hide();for(var n,a=d3.nest().key(function(t){return t.發生地點.substring(0,3)}).key(function(t){return t.案類}).rollup(function(t){return t.length}).entries(data),s=d3.nest().key(function(t){return t.案類}).key(function(t){return t.發生地點.substring(0,3)}).rollup(function(t){return t.length}).entries(data),l=0;22>l;l++)if(r==a[l].key){n=a[l].values;break}for(var l=0;l<n.length;l++)n[l].values=Math.round(n[l].values/e(r)*100)/100;for(var l=0;l<s.length;l++)for(var u=0;u<s[l].values.length;u++)s[l].values[u].values=Math.round(s[l].values[u].values/e(s[l].values[u].key)*100)/100;for(var o=[],l=0;l<n.length;l++)o.push(n[l].values);var i=d3.max(o),c=d3.scale.linear().domain([0,i]).range([0,width-200]),d=d3.scale.linear().domain([0,21]).range([0,height]),f=d3.select("#bar").select("g").selectAll("rect").data(n),v=d3.select("#bar").select("g").selectAll("text").data(n);f.exit().remove(),v.exit().remove(),f.enter().append("rect"),v.enter().append("text"),f.sort(function(t,e){return e.values-t.values}).attr("fill","#fff").transition().duration(750).attr("class",function(t){return t.key}).attr("x",200).attr("y",function(t,e){return d(e)}).attr("width",function(t){return c(t.values)}).attr("height",20).attr("fill",function(t){var e=.9-t.values/i*.6;return d3.hsl(gener_color,e,e)}),v.sort(function(t,e){return e.values-t.values}).transition().duration(750).attr("class","labels").attr("x",0).attr("y",function(t,e){return d(e)+14}).text(function(t){var e=[];for(l=0;l<s.length&&s[l].key!=t.key;l++);for(var r=0;r<s[l].values.length;r++)e.push(s[l].values[r].values);e.sort(function(t,e){return e-t});var n=e.indexOf(t.values);return t.key+"		"+t.values+"(NO."+(n+1)+")"})}function getform(){var t=document.getElementById("City"),e=t.selectedIndex;return e}var gener_color=360,height=600,pop={},data={},topodata2={},width=$(".bar.column").width();width>600&&(width=600),d3.json("./data/city.json",function(t){d3.csv("./data/crim.csv",function(e){d3.json("./data/population.json",function(r){function n(t){function e(){d3.select(this).classed("mouse",!1),d3.selectAll("."+r).classed("mouse",!1)}d3.select(this).classed("mouse",!0).on("mouseleave",e);var r=t.properties.C_Name;d3.selectAll("."+r).classed("mouse",!0)}function a(t){ccrim(t);i.bounds(t);d3.select(this).on("click",s).mouse}function s(){$("#City").attr("disabled",!1),d3.select("form").select("text").attr("x",0).attr("y",0).text(""),change(),$("select").show(),d3.selectAll("path").classed("click",!1).on("click",a)}function l(t){return pop[t]/1e5}data=e,pop=r,topodata2=t,bar(data,pop);var u=topojson.feature(topodata2,topodata2.objects.city).features,o=d3.geo.mercator().center([122,24]).scale(7e3),i=d3.geo.path().projection(o),c=d3.select("#map");c.attr("width",width).attr("height",width/600*650).attr("viewBox","0 0 600 650");for(var d=c.append("g"),f=d3.nest().key(function(t){return t.案類}).key(function(t){return t.發生地點.substring(0,3)}).rollup(function(t){return t.length}).entries(data),v=getform(),h=f[v].values,p=0;p<h.length;p++)h[p].values=Math.round(h[p].values/l(h[p].key)*100)/100;for(var g=[],p=0;p<h.length;p++)g.push(h[p].values);var m=d3.max(g);d.selectAll("path").data(u).enter().append("path").attr("class",function(t){return t.properties.C_Name}).attr("d",i).attr("fill",function(t,e){for(var r=t.properties.C_Name,n=-100,a=0;a<h.length;a++)if(h[a].key==r){n=h[a].values;break}var s=.9-n/m*.6;return d3.hsl(gener_color,s,s)}).classed("city",!0).on("mouseover",n).on("click",a)})})});